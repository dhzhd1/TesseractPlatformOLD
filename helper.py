# coding:'utf-8'

import os
import subprocess
import xml.etree.ElementTree as ET

import math



import re


####################  GPU Info Init ######################
def check_nv_smi(nvidia_smi_path='/usr/bin/nvidia-smi'):
	if not os.path.exists(nvidia_smi_path):
		return False
	else:
		print("'nvidia-smi' tool found!")
		return True

def get_device_num(nvidia_smi='/usr/bin/nvidia-smi'):
	gpu_list = subprocess.check_output([nvidia_smi, '-L']).split('\n')
	gpu_list = [x for x in gpu_list if x != '']
	gpu_amount = len(gpu_list)
	if gpu_amount > 0:
		return gpu_amount
	else:
		print "There is no GPU device in this system!"
		return 0

def query_gpu_info(gpu_amount, nvidia_smi='/usr/bin/nvidia-smi'):
	results = []
	for i in xrange(gpu_amount):
		raw_output = subprocess.check_output([nvidia_smi, '-q', '-i', str(i), '-x'])
		result.append(raw_output)
	return results

def get_gpu_info(xml_content):
	gpu_info_xml = ET.fromstring(xml_content)
	gpu_id = int(gpu_info_xml.findall(".//attached_gpus")[0].text) - int(gpu_info_xml.findall(".//minor_number")[0].text) - 1
	driver_version = gpu_info_xml.findall("./driver_version")[0].text
	# busID = gpu_info_xml.findall(".//gpu")[0].attrib['id']
	busID = gpu_info_xml.findall(".//pci_bus_id")[0].text
	prod_name = gpu_info_xml.findall(".//product_name")[0].text
	prod_brand = gpu_info_xml.findall(".//product_brand")[0].text
	uuid = gpu_info_xml.findall(".//uuid")[0].text
	serial_num = gpu_info_xml.findall(".//serial")[0].text
	vbios_version = gpu_info_xml.findall(".//vbios_version")[0].text
	image_version = gpu_info_xml.findall(".//img_version")[0].text
	total_mem = gpu_info_xml.findall(".//fb_memory_usage/total")[0].text
	ecc_mode = gpu_info_xml.findall(".//ecc_mode/current_ecc")[0].text
	return gpu_id, driver_version, busID, prod_name, prod_brand, uuid, serial_num, vbios_version, image_version, total_mem, ecc_mode


def save_to_database(gpu_id, driver_ver, busID, prod_name, prod_brand, uuid, serial_num, vbios_Ver, image_ver, total_mem, ecc_mode):
	from TesseractPlatform import db, GpuDeviceInfo
	gpu_info = GpuDeviceInfo(gpu_id=gpu_id, driver_ver=driver_ver,
	                         bus_id=busID, prod_name=prod_name,
	                         prod_brand=prod_brand, uuid=uuid,
	                         serial_num=serial_num,vbios_version=vbios_Ver,
	                         gpu_image_version=image_ver, total_mem=total_mem,
	                         ecc_mode=ecc_mode)
	try:
		db.session.add(gpu_info)
		db.session.commit()
		print("save successful!")
	except:
		print("Failed to save the data into database!")

def update_gpu_info():
	NVIDIA_SMI_PATH = '/usr/bin/nvidia-smi'
	if check_nv_smi(NVIDIA_SMI_PATH):
		gpu_amount = get_device_num(NVIDIA_SMI_PATH)
		if gpu_amount > 0:
			print "There {} {} populated in this system!".format(gpu_amount, 'GPUs' if gpu_amount > 1 else "GPU")
			results = query_gpu_info(gpu_amount)
			for result in results:
				gpu_id, driver_version, busID, prod_name, prod_brand, uuid, serial_num, vbios_version, image_version, total_mem, ecc_mode = get_gpu_info(result)
				save_to_database(gpu_id, driver_version, busID, prod_name, prod_brand, uuid, serial_num, vbios_version, image_version, total_mem, ecc_mode)
		else:
			print "There is no GPU device in this system!"
			exit(0)

	else:
		print "No 'nvidia-smi tool found!"
		exit(0)


####################### docker image init ###############################
def check_nv_docker(nvidia_docker_path='/usr/bin/nvidia-docker'):
	if not os.path.exists(nvidia_docker_path):
		print('nvidia-docker not found! please install first')
		# TODO: will add a automation installation script for install the nvidia-docker
		return False
	else:
		print("'nvidia-docker' found!")
		return True

def get_local_image_list():
	from TesseractPlatform import Image
	raw_output = subprocess.check_output(['docker', 'images', '--no-trunc', '--format', '{{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}']).split('\n')
	raw_output = [x for x in raw_output if x != '']
	pattern = r"\S+"
	for line in raw_output:
		columns = re.findall(pattern, line)
		# Columns[0] is 'Repository'
		# Columns[1] is 'Tag'
		# Columns[2] is 'Image ID' without truncated
		# Columns[-1] is 'Size of the Image'
		image_record = Image(repository=columns[0], image_tag=columns[1], image_id=columns[2],
		                     image_size=columns[3],
							 image_type='Public')
		try:
			db.session.add(image_record)
			db.session.commit()
			print("Image record of {} has been saved!".format(columns[2]))
		except Exception as e:
			db.session.rollback()
			print("Save record failed for {}".format(columns[2]))


################## GPU Selected ID Encode #################
def encode_selected_gpu_ids(id_list):
	result = sum([math.pow(2, int(y)) for y in id_list])
	return int(result)

################## GPU Selected ID Decode ##################





if __name__ == '__main__':
	# results=['<?xml version="1.0" ?><!DOCTYPE nvidia_smi_log SYSTEM "nvsmi_device_v9.dtd"><nvidia_smi_log>	<timestamp>Mon Dec 18 16:14:10 2017</timestamp>	<driver_version>384.90</driver_version>	<attached_gpus>4</attached_gpus>	<gpu id="00000000:05:00.0">		<product_name>GeForce GTX 1080 Ti</product_name>		<product_brand>GeForce</product_brand>		<display_mode>Enabled</display_mode>		<display_active>Enabled</display_active>		<persistence_mode>Disabled</persistence_mode>		<accounting_mode>Disabled</accounting_mode>		<accounting_mode_buffer_size>1920</accounting_mode_buffer_size>		<driver_model>			<current_dm>N/A</current_dm>			<pending_dm>N/A</pending_dm>		</driver_model>		<serial>N/A</serial>		<uuid>GPU-7b404b93-3c57-6c50-07d9-cf82431e9784</uuid>		<minor_number>3</minor_number>		<vbios_version>86.02.39.00.22</vbios_version>		<multigpu_board>No</multigpu_board>		<board_id>0x500</board_id>		<gpu_part_number>N/A</gpu_part_number>		<inforom_version>			<img_version>G001.0000.01.04</img_version>			<oem_object>1.1</oem_object>			<ecc_object>N/A</ecc_object>			<pwr_object>N/A</pwr_object>		</inforom_version>		<gpu_operation_mode>			<current_gom>N/A</current_gom>			<pending_gom>N/A</pending_gom>		</gpu_operation_mode>		<gpu_virtualization_mode>			<virtualization_mode>None</virtualization_mode>		</gpu_virtualization_mode>		<pci>			<pci_bus>05</pci_bus>			<pci_device>00</pci_device>			<pci_domain>0000</pci_domain>			<pci_device_id>1B0610DE</pci_device_id>			<pci_bus_id>00000000:05:00.0</pci_bus_id>			<pci_sub_system_id>85E51043</pci_sub_system_id>			<pci_gpu_link_info>				<pcie_gen>					<max_link_gen>3</max_link_gen>					<current_link_gen>1</current_link_gen>				</pcie_gen>				<link_widths>					<max_link_width>16x</max_link_width>					<current_link_width>16x</current_link_width>				</link_widths>			</pci_gpu_link_info>			<pci_bridge_chip>				<bridge_chip_type>N/A</bridge_chip_type>				<bridge_chip_fw>N/A</bridge_chip_fw>			</pci_bridge_chip>			<replay_counter>0</replay_counter>			<tx_util>0 KB/s</tx_util>			<rx_util>0 KB/s</rx_util>		</pci>		<fan_speed>20 %</fan_speed>		<performance_state>P8</performance_state>		<clocks_throttle_reasons>			<clocks_throttle_reason_gpu_idle>Active</clocks_throttle_reason_gpu_idle>			<clocks_throttle_reason_applications_clocks_setting>Not Active</clocks_throttle_reason_applications_clocks_setting>			<clocks_throttle_reason_sw_power_cap>Not Active</clocks_throttle_reason_sw_power_cap>			<clocks_throttle_reason_hw_slowdown>Not Active</clocks_throttle_reason_hw_slowdown>			<clocks_throttle_reason_sync_boost>Not Active</clocks_throttle_reason_sync_boost>			<clocks_throttle_reason_sw_thermal_slowdown>Not Active</clocks_throttle_reason_sw_thermal_slowdown>		</clocks_throttle_reasons>		<fb_memory_usage>			<total>11171 MiB</total>			<used>29 MiB</used>			<free>11142 MiB</free>		</fb_memory_usage>		<bar1_memory_usage>			<total>256 MiB</total>			<used>5 MiB</used>			<free>251 MiB</free>		</bar1_memory_usage>		<compute_mode>Default</compute_mode>		<utilization>			<gpu_util>0 %</gpu_util>			<memory_util>1 %</memory_util>			<encoder_util>0 %</encoder_util>			<decoder_util>0 %</decoder_util>		</utilization>		<encoder_stats>			<session_count>0</session_count>			<average_fps>0</average_fps>			<average_latency>0</average_latency>		</encoder_stats>		<ecc_mode>			<current_ecc>N/A</current_ecc>			<pending_ecc>N/A</pending_ecc>		</ecc_mode>		<ecc_errors>			<volatile>				<single_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</single_bit>				<double_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</double_bit>			</volatile>			<aggregate>				<single_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</single_bit>				<double_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</double_bit>			</aggregate>		</ecc_errors>		<retired_pages>			<multiple_single_bit_retirement>				<retired_count>N/A</retired_count>				<retired_page_addresses>N/A</retired_page_addresses>			</multiple_single_bit_retirement>			<double_bit_retirement>				<retired_count>N/A</retired_count>				<retired_page_addresses>N/A</retired_page_addresses>			</double_bit_retirement>			<pending_retirement>N/A</pending_retirement>		</retired_pages>		<temperature>			<gpu_temp>43 C</gpu_temp>			<gpu_temp_max_threshold>96 C</gpu_temp_max_threshold>			<gpu_temp_slow_threshold>93 C</gpu_temp_slow_threshold>			<gpu_temp_max_gpu_threshold>N/A</gpu_temp_max_gpu_threshold>			<memory_temp>N/A</memory_temp>			<gpu_temp_max_mem_threshold>N/A</gpu_temp_max_mem_threshold>		</temperature>		<power_readings>			<power_state>P8</power_state>			<power_management>Supported</power_management>			<power_draw>12.57 W</power_draw>			<power_limit>250.00 W</power_limit>			<default_power_limit>250.00 W</default_power_limit>			<enforced_power_limit>250.00 W</enforced_power_limit>			<min_power_limit>125.00 W</min_power_limit>			<max_power_limit>300.00 W</max_power_limit>		</power_readings>		<clocks>			<graphics_clock>139 MHz</graphics_clock>			<sm_clock>139 MHz</sm_clock>			<mem_clock>405 MHz</mem_clock>			<video_clock>544 MHz</video_clock>		</clocks>		<applications_clocks>			<graphics_clock>N/A</graphics_clock>			<mem_clock>N/A</mem_clock>		</applications_clocks>		<default_applications_clocks>			<graphics_clock>N/A</graphics_clock>			<mem_clock>N/A</mem_clock>		</default_applications_clocks>		<max_clocks>			<graphics_clock>1911 MHz</graphics_clock>			<sm_clock>1911 MHz</sm_clock>			<mem_clock>5505 MHz</mem_clock>			<video_clock>1708 MHz</video_clock>		</max_clocks>		<max_customer_boost_clocks>			<graphics_clock>N/A</graphics_clock>		</max_customer_boost_clocks>		<clock_policy>			<auto_boost>N/A</auto_boost>			<auto_boost_default>N/A</auto_boost_default>		</clock_policy>		<supported_clocks>N/A</supported_clocks>		<processes>			<process_info>				<pid>1556</pid>				<type>G</type>				<process_name>/usr/lib/xorg/Xorg</process_name>				<used_memory>26 MiB</used_memory>			</process_info>		</processes>		<accounted_processes>		</accounted_processes>	</gpu></nvidia_smi_log>',
	# 		 '<?xml version="1.0" ?><!DOCTYPE nvidia_smi_log SYSTEM "nvsmi_device_v9.dtd"><nvidia_smi_log>	<timestamp>Mon Dec 18 16:20:48 2017</timestamp>	<driver_version>384.90</driver_version>	<attached_gpus>4</attached_gpus>	<gpu id="00000000:06:00.0">		<product_name>GeForce GTX 1080 Ti</product_name>		<product_brand>GeForce</product_brand>		<display_mode>Disabled</display_mode>		<display_active>Disabled</display_active>		<persistence_mode>Disabled</persistence_mode>		<accounting_mode>Disabled</accounting_mode>		<accounting_mode_buffer_size>1920</accounting_mode_buffer_size>		<driver_model>			<current_dm>N/A</current_dm>			<pending_dm>N/A</pending_dm>		</driver_model>		<serial>N/A</serial>		<uuid>GPU-d3cd55dc-aa24-5d61-1854-55230b426274</uuid>		<minor_number>2</minor_number>		<vbios_version>86.02.39.00.22</vbios_version>		<multigpu_board>No</multigpu_board>		<board_id>0x600</board_id>		<gpu_part_number>N/A</gpu_part_number>		<inforom_version>			<img_version>G001.0000.01.04</img_version>			<oem_object>1.1</oem_object>			<ecc_object>N/A</ecc_object>			<pwr_object>N/A</pwr_object>		</inforom_version>		<gpu_operation_mode>			<current_gom>N/A</current_gom>			<pending_gom>N/A</pending_gom>		</gpu_operation_mode>		<gpu_virtualization_mode>			<virtualization_mode>None</virtualization_mode>		</gpu_virtualization_mode>		<pci>			<pci_bus>06</pci_bus>			<pci_device>00</pci_device>			<pci_domain>0000</pci_domain>			<pci_device_id>1B0610DE</pci_device_id>			<pci_bus_id>00000000:06:00.0</pci_bus_id>			<pci_sub_system_id>85E51043</pci_sub_system_id>			<pci_gpu_link_info>				<pcie_gen>					<max_link_gen>3</max_link_gen>					<current_link_gen>1</current_link_gen>				</pcie_gen>				<link_widths>					<max_link_width>16x</max_link_width>					<current_link_width>16x</current_link_width>				</link_widths>			</pci_gpu_link_info>			<pci_bridge_chip>				<bridge_chip_type>N/A</bridge_chip_type>				<bridge_chip_fw>N/A</bridge_chip_fw>			</pci_bridge_chip>			<replay_counter>0</replay_counter>			<tx_util>0 KB/s</tx_util>			<rx_util>0 KB/s</rx_util>		</pci>		<fan_speed>20 %</fan_speed>		<performance_state>P8</performance_state>		<clocks_throttle_reasons>			<clocks_throttle_reason_gpu_idle>Active</clocks_throttle_reason_gpu_idle>			<clocks_throttle_reason_applications_clocks_setting>Not Active</clocks_throttle_reason_applications_clocks_setting>			<clocks_throttle_reason_sw_power_cap>Not Active</clocks_throttle_reason_sw_power_cap>			<clocks_throttle_reason_hw_slowdown>Not Active</clocks_throttle_reason_hw_slowdown>			<clocks_throttle_reason_sync_boost>Not Active</clocks_throttle_reason_sync_boost>			<clocks_throttle_reason_sw_thermal_slowdown>Not Active</clocks_throttle_reason_sw_thermal_slowdown>		</clocks_throttle_reasons>		<fb_memory_usage>			<total>11172 MiB</total>			<used>2 MiB</used>			<free>11170 MiB</free>		</fb_memory_usage>		<bar1_memory_usage>			<total>256 MiB</total>			<used>5 MiB</used>			<free>251 MiB</free>		</bar1_memory_usage>		<compute_mode>Default</compute_mode>		<utilization>			<gpu_util>0 %</gpu_util>			<memory_util>0 %</memory_util>			<encoder_util>0 %</encoder_util>			<decoder_util>0 %</decoder_util>		</utilization>		<encoder_stats>			<session_count>0</session_count>			<average_fps>0</average_fps>			<average_latency>0</average_latency>		</encoder_stats>		<ecc_mode>			<current_ecc>N/A</current_ecc>			<pending_ecc>N/A</pending_ecc>		</ecc_mode>		<ecc_errors>			<volatile>				<single_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</single_bit>				<double_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</double_bit>			</volatile>			<aggregate>				<single_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</single_bit>				<double_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</double_bit>			</aggregate>		</ecc_errors>		<retired_pages>			<multiple_single_bit_retirement>				<retired_count>N/A</retired_count>				<retired_page_addresses>N/A</retired_page_addresses>			</multiple_single_bit_retirement>			<double_bit_retirement>				<retired_count>N/A</retired_count>				<retired_page_addresses>N/A</retired_page_addresses>			</double_bit_retirement>			<pending_retirement>N/A</pending_retirement>		</retired_pages>		<temperature>			<gpu_temp>37 C</gpu_temp>			<gpu_temp_max_threshold>96 C</gpu_temp_max_threshold>			<gpu_temp_slow_threshold>93 C</gpu_temp_slow_threshold>			<gpu_temp_max_gpu_threshold>N/A</gpu_temp_max_gpu_threshold>			<memory_temp>N/A</memory_temp>			<gpu_temp_max_mem_threshold>N/A</gpu_temp_max_mem_threshold>		</temperature>		<power_readings>			<power_state>P8</power_state>			<power_management>Supported</power_management>			<power_draw>10.25 W</power_draw>			<power_limit>250.00 W</power_limit>			<default_power_limit>250.00 W</default_power_limit>			<enforced_power_limit>250.00 W</enforced_power_limit>			<min_power_limit>125.00 W</min_power_limit>			<max_power_limit>300.00 W</max_power_limit>		</power_readings>		<clocks>			<graphics_clock>139 MHz</graphics_clock>			<sm_clock>139 MHz</sm_clock>			<mem_clock>405 MHz</mem_clock>			<video_clock>544 MHz</video_clock>		</clocks>		<applications_clocks>			<graphics_clock>N/A</graphics_clock>			<mem_clock>N/A</mem_clock>		</applications_clocks>		<default_applications_clocks>			<graphics_clock>N/A</graphics_clock>			<mem_clock>N/A</mem_clock>		</default_applications_clocks>		<max_clocks>			<graphics_clock>1911 MHz</graphics_clock>			<sm_clock>1911 MHz</sm_clock>			<mem_clock>5505 MHz</mem_clock>			<video_clock>1708 MHz</video_clock>		</max_clocks>		<max_customer_boost_clocks>			<graphics_clock>N/A</graphics_clock>		</max_customer_boost_clocks>		<clock_policy>			<auto_boost>N/A</auto_boost>			<auto_boost_default>N/A</auto_boost_default>		</clock_policy>		<supported_clocks>N/A</supported_clocks>		<processes>		</processes>		<accounted_processes>		</accounted_processes>	</gpu></nvidia_smi_log>',
	#          '<?xml version="1.0" ?><!DOCTYPE nvidia_smi_log SYSTEM "nvsmi_device_v9.dtd"><nvidia_smi_log>	<timestamp>Mon Dec 18 16:21:38 2017</timestamp>	<driver_version>384.90</driver_version>	<attached_gpus>4</attached_gpus>	<gpu id="00000000:09:00.0">		<product_name>GeForce GTX 1080 Ti</product_name>		<product_brand>GeForce</product_brand>		<display_mode>Disabled</display_mode>		<display_active>Disabled</display_active>		<persistence_mode>Disabled</persistence_mode>		<accounting_mode>Disabled</accounting_mode>		<accounting_mode_buffer_size>1920</accounting_mode_buffer_size>		<driver_model>			<current_dm>N/A</current_dm>			<pending_dm>N/A</pending_dm>		</driver_model>		<serial>N/A</serial>		<uuid>GPU-6962408b-84d6-a20f-0ea8-75f628cdf17b</uuid>		<minor_number>1</minor_number>		<vbios_version>86.02.39.00.22</vbios_version>		<multigpu_board>No</multigpu_board>		<board_id>0x900</board_id>		<gpu_part_number>N/A</gpu_part_number>		<inforom_version>			<img_version>G001.0000.01.04</img_version>			<oem_object>1.1</oem_object>			<ecc_object>N/A</ecc_object>			<pwr_object>N/A</pwr_object>		</inforom_version>		<gpu_operation_mode>			<current_gom>N/A</current_gom>			<pending_gom>N/A</pending_gom>		</gpu_operation_mode>		<gpu_virtualization_mode>			<virtualization_mode>None</virtualization_mode>		</gpu_virtualization_mode>		<pci>			<pci_bus>09</pci_bus>			<pci_device>00</pci_device>			<pci_domain>0000</pci_domain>			<pci_device_id>1B0610DE</pci_device_id>			<pci_bus_id>00000000:09:00.0</pci_bus_id>			<pci_sub_system_id>85E51043</pci_sub_system_id>			<pci_gpu_link_info>				<pcie_gen>					<max_link_gen>3</max_link_gen>					<current_link_gen>1</current_link_gen>				</pcie_gen>				<link_widths>					<max_link_width>16x</max_link_width>					<current_link_width>16x</current_link_width>				</link_widths>			</pci_gpu_link_info>			<pci_bridge_chip>				<bridge_chip_type>N/A</bridge_chip_type>				<bridge_chip_fw>N/A</bridge_chip_fw>			</pci_bridge_chip>			<replay_counter>0</replay_counter>			<tx_util>0 KB/s</tx_util>			<rx_util>0 KB/s</rx_util>		</pci>		<fan_speed>20 %</fan_speed>		<performance_state>P8</performance_state>		<clocks_throttle_reasons>			<clocks_throttle_reason_gpu_idle>Active</clocks_throttle_reason_gpu_idle>			<clocks_throttle_reason_applications_clocks_setting>Not Active</clocks_throttle_reason_applications_clocks_setting>			<clocks_throttle_reason_sw_power_cap>Not Active</clocks_throttle_reason_sw_power_cap>			<clocks_throttle_reason_hw_slowdown>Not Active</clocks_throttle_reason_hw_slowdown>			<clocks_throttle_reason_sync_boost>Not Active</clocks_throttle_reason_sync_boost>			<clocks_throttle_reason_sw_thermal_slowdown>Not Active</clocks_throttle_reason_sw_thermal_slowdown>		</clocks_throttle_reasons>		<fb_memory_usage>			<total>11172 MiB</total>			<used>2 MiB</used>			<free>11170 MiB</free>		</fb_memory_usage>		<bar1_memory_usage>			<total>256 MiB</total>			<used>5 MiB</used>			<free>251 MiB</free>		</bar1_memory_usage>		<compute_mode>Default</compute_mode>		<utilization>			<gpu_util>0 %</gpu_util>			<memory_util>0 %</memory_util>			<encoder_util>0 %</encoder_util>			<decoder_util>0 %</decoder_util>		</utilization>		<encoder_stats>			<session_count>0</session_count>			<average_fps>0</average_fps>			<average_latency>0</average_latency>		</encoder_stats>		<ecc_mode>			<current_ecc>N/A</current_ecc>			<pending_ecc>N/A</pending_ecc>		</ecc_mode>		<ecc_errors>			<volatile>				<single_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</single_bit>				<double_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</double_bit>			</volatile>			<aggregate>				<single_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</single_bit>				<double_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</double_bit>			</aggregate>		</ecc_errors>		<retired_pages>			<multiple_single_bit_retirement>				<retired_count>N/A</retired_count>				<retired_page_addresses>N/A</retired_page_addresses>			</multiple_single_bit_retirement>			<double_bit_retirement>				<retired_count>N/A</retired_count>				<retired_page_addresses>N/A</retired_page_addresses>			</double_bit_retirement>			<pending_retirement>N/A</pending_retirement>		</retired_pages>		<temperature>			<gpu_temp>32 C</gpu_temp>			<gpu_temp_max_threshold>96 C</gpu_temp_max_threshold>			<gpu_temp_slow_threshold>93 C</gpu_temp_slow_threshold>			<gpu_temp_max_gpu_threshold>N/A</gpu_temp_max_gpu_threshold>			<memory_temp>N/A</memory_temp>			<gpu_temp_max_mem_threshold>N/A</gpu_temp_max_mem_threshold>		</temperature>		<power_readings>			<power_state>P8</power_state>			<power_management>Supported</power_management>			<power_draw>9.67 W</power_draw>			<power_limit>250.00 W</power_limit>			<default_power_limit>250.00 W</default_power_limit>			<enforced_power_limit>250.00 W</enforced_power_limit>			<min_power_limit>125.00 W</min_power_limit>			<max_power_limit>300.00 W</max_power_limit>		</power_readings>		<clocks>			<graphics_clock>139 MHz</graphics_clock>			<sm_clock>139 MHz</sm_clock>			<mem_clock>405 MHz</mem_clock>			<video_clock>544 MHz</video_clock>		</clocks>		<applications_clocks>			<graphics_clock>N/A</graphics_clock>			<mem_clock>N/A</mem_clock>		</applications_clocks>		<default_applications_clocks>			<graphics_clock>N/A</graphics_clock>			<mem_clock>N/A</mem_clock>		</default_applications_clocks>		<max_clocks>			<graphics_clock>1911 MHz</graphics_clock>			<sm_clock>1911 MHz</sm_clock>			<mem_clock>5505 MHz</mem_clock>			<video_clock>1708 MHz</video_clock>		</max_clocks>		<max_customer_boost_clocks>			<graphics_clock>N/A</graphics_clock>		</max_customer_boost_clocks>		<clock_policy>			<auto_boost>N/A</auto_boost>			<auto_boost_default>N/A</auto_boost_default>		</clock_policy>		<supported_clocks>N/A</supported_clocks>		<processes>		</processes>		<accounted_processes>		</accounted_processes>	</gpu></nvidia_smi_log>',
	#          '<?xml version="1.0" ?><!DOCTYPE nvidia_smi_log SYSTEM "nvsmi_device_v9.dtd"><nvidia_smi_log>	<timestamp>Mon Dec 18 16:22:11 2017</timestamp>	<driver_version>384.90</driver_version>	<attached_gpus>4</attached_gpus>	<gpu id="00000000:0A:00.0">		<product_name>GeForce GTX 1080 Ti</product_name>		<product_brand>GeForce</product_brand>		<display_mode>Disabled</display_mode>		<display_active>Disabled</display_active>		<persistence_mode>Disabled</persistence_mode>		<accounting_mode>Disabled</accounting_mode>		<accounting_mode_buffer_size>1920</accounting_mode_buffer_size>		<driver_model>			<current_dm>N/A</current_dm>			<pending_dm>N/A</pending_dm>		</driver_model>		<serial>N/A</serial>		<uuid>GPU-80a88eb2-245c-f16d-a504-6ef0e8acbf80</uuid>		<minor_number>0</minor_number>		<vbios_version>86.02.39.00.22</vbios_version>		<multigpu_board>No</multigpu_board>		<board_id>0xa00</board_id>		<gpu_part_number>N/A</gpu_part_number>		<inforom_version>			<img_version>G001.0000.01.04</img_version>			<oem_object>1.1</oem_object>			<ecc_object>N/A</ecc_object>			<pwr_object>N/A</pwr_object>		</inforom_version>		<gpu_operation_mode>			<current_gom>N/A</current_gom>			<pending_gom>N/A</pending_gom>		</gpu_operation_mode>		<gpu_virtualization_mode>			<virtualization_mode>None</virtualization_mode>		</gpu_virtualization_mode>		<pci>			<pci_bus>0A</pci_bus>			<pci_device>00</pci_device>			<pci_domain>0000</pci_domain>			<pci_device_id>1B0610DE</pci_device_id>			<pci_bus_id>00000000:0A:00.0</pci_bus_id>			<pci_sub_system_id>85E51043</pci_sub_system_id>			<pci_gpu_link_info>				<pcie_gen>					<max_link_gen>3</max_link_gen>					<current_link_gen>1</current_link_gen>				</pcie_gen>				<link_widths>					<max_link_width>16x</max_link_width>					<current_link_width>16x</current_link_width>				</link_widths>			</pci_gpu_link_info>			<pci_bridge_chip>				<bridge_chip_type>N/A</bridge_chip_type>				<bridge_chip_fw>N/A</bridge_chip_fw>			</pci_bridge_chip>			<replay_counter>0</replay_counter>			<tx_util>0 KB/s</tx_util>			<rx_util>0 KB/s</rx_util>		</pci>		<fan_speed>20 %</fan_speed>		<performance_state>P8</performance_state>		<clocks_throttle_reasons>			<clocks_throttle_reason_gpu_idle>Active</clocks_throttle_reason_gpu_idle>			<clocks_throttle_reason_applications_clocks_setting>Not Active</clocks_throttle_reason_applications_clocks_setting>			<clocks_throttle_reason_sw_power_cap>Not Active</clocks_throttle_reason_sw_power_cap>			<clocks_throttle_reason_hw_slowdown>Not Active</clocks_throttle_reason_hw_slowdown>			<clocks_throttle_reason_sync_boost>Not Active</clocks_throttle_reason_sync_boost>			<clocks_throttle_reason_sw_thermal_slowdown>Not Active</clocks_throttle_reason_sw_thermal_slowdown>		</clocks_throttle_reasons>		<fb_memory_usage>			<total>11172 MiB</total>			<used>2 MiB</used>			<free>11170 MiB</free>		</fb_memory_usage>		<bar1_memory_usage>			<total>256 MiB</total>			<used>5 MiB</used>			<free>251 MiB</free>		</bar1_memory_usage>		<compute_mode>Default</compute_mode>		<utilization>			<gpu_util>0 %</gpu_util>			<memory_util>0 %</memory_util>			<encoder_util>0 %</encoder_util>			<decoder_util>0 %</decoder_util>		</utilization>		<encoder_stats>			<session_count>0</session_count>			<average_fps>0</average_fps>			<average_latency>0</average_latency>		</encoder_stats>		<ecc_mode>			<current_ecc>N/A</current_ecc>			<pending_ecc>N/A</pending_ecc>		</ecc_mode>		<ecc_errors>			<volatile>				<single_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</single_bit>				<double_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</double_bit>			</volatile>			<aggregate>				<single_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</single_bit>				<double_bit>					<device_memory>N/A</device_memory>					<register_file>N/A</register_file>					<l1_cache>N/A</l1_cache>					<l2_cache>N/A</l2_cache>					<texture_memory>N/A</texture_memory>					<texture_shm>N/A</texture_shm>					<cbu>N/A</cbu>					<total>N/A</total>				</double_bit>			</aggregate>		</ecc_errors>		<retired_pages>			<multiple_single_bit_retirement>				<retired_count>N/A</retired_count>				<retired_page_addresses>N/A</retired_page_addresses>			</multiple_single_bit_retirement>			<double_bit_retirement>				<retired_count>N/A</retired_count>				<retired_page_addresses>N/A</retired_page_addresses>			</double_bit_retirement>			<pending_retirement>N/A</pending_retirement>		</retired_pages>		<temperature>			<gpu_temp>25 C</gpu_temp>			<gpu_temp_max_threshold>96 C</gpu_temp_max_threshold>			<gpu_temp_slow_threshold>93 C</gpu_temp_slow_threshold>			<gpu_temp_max_gpu_threshold>N/A</gpu_temp_max_gpu_threshold>			<memory_temp>N/A</memory_temp>			<gpu_temp_max_mem_threshold>N/A</gpu_temp_max_mem_threshold>		</temperature>		<power_readings>			<power_state>P8</power_state>			<power_management>Supported</power_management>			<power_draw>9.66 W</power_draw>			<power_limit>250.00 W</power_limit>			<default_power_limit>250.00 W</default_power_limit>			<enforced_power_limit>250.00 W</enforced_power_limit>			<min_power_limit>125.00 W</min_power_limit>			<max_power_limit>300.00 W</max_power_limit>		</power_readings>		<clocks>			<graphics_clock>139 MHz</graphics_clock>			<sm_clock>139 MHz</sm_clock>			<mem_clock>405 MHz</mem_clock>			<video_clock>544 MHz</video_clock>		</clocks>		<applications_clocks>			<graphics_clock>N/A</graphics_clock>			<mem_clock>N/A</mem_clock>		</applications_clocks>		<default_applications_clocks>			<graphics_clock>N/A</graphics_clock>			<mem_clock>N/A</mem_clock>		</default_applications_clocks>		<max_clocks>			<graphics_clock>1911 MHz</graphics_clock>			<sm_clock>1911 MHz</sm_clock>			<mem_clock>5505 MHz</mem_clock>			<video_clock>1708 MHz</video_clock>		</max_clocks>		<max_customer_boost_clocks>			<graphics_clock>N/A</graphics_clock>		</max_customer_boost_clocks>		<clock_policy>			<auto_boost>N/A</auto_boost>			<auto_boost_default>N/A</auto_boost_default>		</clock_policy>		<supported_clocks>N/A</supported_clocks>		<processes>		</processes>		<accounted_processes>		</accounted_processes>	</gpu></nvidia_smi_log>']
	# for result in results:
	# 	gpu_id, driver_version, busID, prod_name, prod_brand, uuid, serial_num, vbios_version, image_version, total_mem, ecc_mode = get_gpu_info(result)
	# 	save_to_database(gpu_id, driver_version, busID, prod_name, prod_brand, uuid, serial_num, vbios_version, image_version,
	# 	                 total_mem, ecc_mode)
	# get_local_image_list()
	id_list = [u'0', u'1', u'2', u'3']
	print(encode_selected_gpu_ids(id_list))